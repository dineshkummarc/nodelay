<!DOCTYPE html>
<html>
    <head>
        <title>Nodelay</title>
        <!-- these three files are for Flash websocket support -->
        <script type="text/javascript" src="web-socket-js/swfobject.js"></script>
        <script type="text/javascript" src="web-socket-js/FABridge.js"></script>
        <script type="text/javascript" src="web-socket-js/web_socket.js"></script>        
        <script type="text/javascript">

        // these globals are for the Flash WebSocket implementation
        WEB_SOCKET_SWF_LOCATION = "web-socket-js/WebSocketMain.swf";
        WEB_SOCKET_DEBUG = true;
        
        var url, message, status;
        
        var minRetryWait = 5000,
            retryWait = minRetryWait, 
            maxRetryWait = 60000;
        
        window.onload = function() {

            url = "ws://"+document.location.host+":8080";
            
            messages = document.getElementById('messages');
            status = document.getElementById('status');
            
            status.innerHTML = "Connecting...";
            
            var ws = new WebSocket(url);
            setUpEvents(ws);
            
        }
        
        function setUpEvents(ws) {
        
            ws.onclose = function() {
                status.innerHTML = "WebSocket closed, retrying in " + Math.round(retryWait/1000) + " seconds!";                
                setTimeout(function() {
                    status.innerHTML = "Reconnecting...";                
                    var retryWs = new WebSocket(url);
                    setUpEvents(retryWs);
                }, retryWait);
                retryWait *= 2;
                retryWait = Math.min(maxRetryWait, retryWait);
            };

            ws.onerror = function() {
                status.innerHTML = "Error with WebSocket, try refreshing?";
            };

            ws.onopen = function() {
                status.innerHTML = "Connected! Waiting for messages...";
                retryWait = minRetryWait;
            };
            
            ws.onmessage = function(evt) {
                if (status.innerHTML == "Connected! Waiting for messages...") {
                    status.innerHTML = "";
                }            
                var li = document.createElement('li');
                li.innerHTML = formatEdit(JSON.parse(evt.data));
                messages.appendChild(li);
                if (messages.children.length > 20) {
                    messages.removeChild(messages.firstChild);
                }
            }
            
            // TODO: let's try reconnecting if the socket closes or hangs?
            
        }
        
        function formatEdit(edit) {
            var out = "<a href=\""+edit.url+"\">"+edit.title+"<\/a> " + edit.change + " " + edit.text
            // Add types from metaweb
            if (edit.types) {
                var typetext = [];
                for (var i = 0, l = edit.types.length; i < l; i++) {
                    var type = edit.types[i];
                    typetext.push(type.text);
                }
                out += '. Types: ' + typetext.join(', ');
            }
            // Add wikipedia metadata
            if (edit.metadata) {
                for (var pageid in edit.metadata.pages) {
                    var page = edit.metadata.pages[pageid];
                    out += '. Modified: ' + page.touched + ', Edit counter: ' + page.counter + ', Size: ' + page.length;
                }
            }
            return out;
        }
        
        </script>
        <style type="text/css">
            body {
                background: #444;
                color: white;
                margin: 20px;
                font: 14px/1.2 Helvetica, sans-serif;
            }
            a {
                color: yellow;
            }
            img#doggy {
                margin-left: 10px;
                margin-bottom: 20px;
                border-right: 1px solid white;
                border-bottom: 1px solid white;
            }
            h1, h2 {
                color: #00ff99;
                text-shadow: 3px 3px 8px #000;
            }
        </style>
    </head>
    <body>
        <h1>Nodelay!</h1>
        <p>This page shows recent edits to the English language wikipedia, <em>right now</em>.</p>
        <p id="status"></p>
        <ul id="messages">
        </ul>
        <img id="doggy" src="images/nodelayKnockout.jpg" align="right">
        <h2>What / Why / How?</h2>
        <p>You're looking at team Nodelay's entry into <a href="http://nodeknockout.com/">Node Knockout</a>, a 48hr programming contest to explore <a href="http://nodejs.org/">node.js</a>.</p>
        <p>So far we're using <a href="http://github.com/gf3/Jerk/">Jerk</a>, <a href="http://github.com/miksago/node-websocket-server">node-websocket-server</a> <a href="http://github.com/cloudhead/node-static">node-static</a> and <a href="http://howtonode.org/step-of-conductor">Step</a> to help parallelize HTTP requests. We borrowed a bit of <a href="http://www.jibble.org/pircbot.php">Pircbot</a> to strip formatting information. WebSockets seem to be working in Firefox thanks to a bit of Flash glue from <a href="http://github.com/gimite/web-socket-js/">web-socket-js</a> and a good old fashioned <a href="http://github.com/waywardmonkeys/netty-flash-crossdomain-policy-server/blob/master/sample_flash_policy.xml">socket policy file</a> on port 843.</p>
        <p>We're listening to the English <a href="http://meta.wikimedia.org/wiki/IRC_Channels#Recent_changes">Wikipedia IRC server</a> for update notifications.  For each update, we request the page edit metadata using the <a href="http://www.mediawiki.org/wiki/API">Wikipedia APIs</a> and load additional semantic category data from <a href="http://www.freebase.com/docs/data">Metaweb's Freebase database</a>.  Finally, we return an annotated JSON object to the browser using the <a href="http://dev.w3.org/html5/websockets/">HTML5 Web Socket APIs</a>. Mashup-tastic!</p>
        <a href="http://nodeknockout.com/teams/nodelay" target="nko" title="Help me win Node.js KO!"><img style="position: fixed; top: 5px; right: 5px; border: 0px;" src="http://nodeknockout.com/images/voteko.png" alt="Help me win Node.js KO!" /></a>
    </body>
</html>
